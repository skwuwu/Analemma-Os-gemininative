{
    "workflow_name": "test_llm_stage3_vision_basic",
    "description": "Stage 3: 멀티모달 기초 - S3 이미지 하이드레이션 및 Vision JSON 추출 검증",
    "version": "1.0.0",
    "metadata": {
        "stage": 3,
        "guardrails": [],
        "safety_limits": {
            "max_iterations": 1,
            "max_tokens_total": 8000,
            "timeout_seconds": 120
        },
        "vision_test": {
            "verify_s3_to_bytes": true,
            "verify_json_parseable": true
        }
    },
    "nodes": [
        {
            "id": "start",
            "type": "operator_official",
            "label": "워크플로우 시작",
            "config": {
                "strategy": "timestamp",
                "params": {
                    "format": "iso"
                },
                "output_key": "workflow_start_time"
            }
        },
        {
            "id": "prepare_image_input",
            "type": "operator_official",
            "label": "이미지 입력 준비",
            "config": {
                "strategy": "merge_objects",
                "params": {
                    "objects": [
                        {
                            "image_source": "{{image_uri}}"
                        },
                        {
                            "extraction_fields": [
                                "amount",
                                "date",
                                "vendor",
                                "items"
                            ]
                        }
                    ]
                },
                "output_key": "image_config"
            }
        },
        {
            "id": "record_hydration_start",
            "type": "operator_official",
            "label": "하이드레이션 시작 시간",
            "config": {
                "strategy": "timestamp",
                "params": {
                    "format": "epoch_ms"
                },
                "output_key": "hydration_start_ms"
            }
        },
        {
            "id": "vision_analysis",
            "type": "llm_chat",
            "label": "Gemini Vision 이미지 분석",
            "config": {
                "provider": "gemini",
                "model": "gemini-2.0-flash",
                "vision_enabled": true,
                "system_prompt": "You are a document analyzer. Extract ONLY the data visible in the image. Do NOT invent or hallucinate information. If data is not visible, return null. Be concise - use short strings only.",
                "prompt_content": "Analyze this image: {{image_uri}}\n\nExtract these fields in JSON format:\n- amount: number or null (total amount if visible)\n- date: string \"YYYY-MM-DD\" or null\n- vendor: string (ONLY the company name, max 50 chars) or null\n- items: array of strings (item names only)\n\nIMPORTANT:\n- Return null for any field not clearly visible in the image\n- Do NOT make up or guess any information\n- Keep vendor name SHORT (just the company name, no descriptions)\n- If this is not a receipt/document, set all fields to null",
                "max_tokens": 512,
                "temperature": 0.1,
                "response_schema": {
                    "type": "object",
                    "properties": {
                        "amount": {
                            "type": "number",
                            "nullable": true,
                            "description": "Total amount or main value from image"
                        },
                        "date": {
                            "type": "string",
                            "nullable": true,
                            "description": "Date in YYYY-MM-DD format"
                        },
                        "vendor": {
                            "type": "string",
                            "nullable": true,
                            "description": "Company or store name (short, max 50 chars)",
                            "maxLength": 50
                        },
                        "items": {
                            "type": "array",
                            "items": {
                                "type": "string",
                                "maxLength": 100
                            },
                            "maxItems": 20,
                            "description": "List of items or components"
                        },
                        "confidence": {
                            "type": "number",
                            "description": "Confidence score 0-1"
                        },
                        "image_type": {
                            "type": "string",
                            "enum": ["receipt", "invoice", "document", "product", "other", "unknown"],
                            "description": "Type of image detected"
                        }
                    }
                },
                "output_key": "vision_raw_output"
            }
        },
        {
            "id": "record_hydration_end",
            "type": "operator_official",
            "label": "하이드레이션 종료 시간",
            "config": {
                "strategy": "timestamp",
                "params": {
                    "format": "epoch_ms"
                },
                "output_key": "hydration_end_ms"
            }
        },
        {
            "id": "parse_vision_output",
            "type": "operator_official",
            "label": "Vision 출력 JSON 파싱",
            "config": {
                "strategy": "json_parse",
                "input_key": "vision_raw_output",
                "params": {
                    "strict": false,
                    "default": {
                        "amount": null,
                        "date": null,
                        "vendor": "parse_failed",
                        "items": [],
                        "confidence": 0
                    }
                },
                "output_key": "parsed_vision_data"
            }
        },
        {
            "id": "validate_extraction",
            "type": "operator_official",
            "label": "추출 결과 검증",
            "config": {
                "strategy": "if_else",
                "input_key": "parsed_vision_data",
                "params": {
                    "condition": "$.parsed_vision_data.vendor != 'parse_failed'",
                    "then": "extraction_valid",
                    "else": "extraction_failed"
                },
                "output_key": "extraction_status"
            }
        },
        {
            "id": "process_extracted_data",
            "type": "operator_official",
            "label": "추출 데이터 가공 (operator_official 연동 검증)",
            "config": {
                "strategy": "pick_fields",
                "input_key": "parsed_vision_data",
                "params": {
                    "fields": [
                        "amount",
                        "date",
                        "vendor",
                        "confidence"
                    ]
                },
                "output_key": "clean_vision_data"
            }
        },
        {
            "id": "finalize",
            "type": "operator_official",
            "label": "결과 정리",
            "config": {
                "strategy": "merge_objects",
                "params": {
                    "objects": [
                        {
                            "status": "COMPLETE"
                        },
                        {
                            "stage": 3
                        },
                        {
                            "test": "vision_basic_hydration"
                        }
                    ]
                },
                "output_key": "final_status"
            }
        }
    ],
    "edges": [
        {
            "source": "start",
            "target": "prepare_image_input"
        },
        {
            "source": "prepare_image_input",
            "target": "record_hydration_start"
        },
        {
            "source": "record_hydration_start",
            "target": "vision_analysis"
        },
        {
            "source": "vision_analysis",
            "target": "record_hydration_end"
        },
        {
            "source": "record_hydration_end",
            "target": "parse_vision_output"
        },
        {
            "source": "parse_vision_output",
            "target": "validate_extraction"
        },
        {
            "source": "validate_extraction",
            "target": "process_extracted_data"
        },
        {
            "source": "process_extracted_data",
            "target": "finalize"
        }
    ],
    "start_node": "start",
    "initial_state": {
        "image_uri": "s3://analemma-workflows-dev/test-images/sample_receipt.png",
        "test_mode": "vision_basic"
    }
}