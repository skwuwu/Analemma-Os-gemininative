{
    "workflow_name": "LLM Stage 8 - Slop Detection & Quality Gate",
    "description": "ìŠ¬ë¡­ íƒì§€ê¸° ê²€ì¦: ì»¤ë„ ë ˆë²¨ _kernel_quality_check ìë™ ì¸í„°ì…‰íŠ¸ í™œìš© (operator_official ë¦¬íŒ©í† ë§)",
    "version": "2.2.0",
    "test_stage": 8,
    "nodes": [
        {
            "id": "init_slop_test",
            "type": "operator_official",
            "config": {
                "strategy": "merge_objects",
                "params": {
                    "objects": [
                        {
                            "slop_detection_metrics": {
                                "true_positives": 0,
                                "true_negatives": 0,
                                "false_positives": 0,
                                "false_negatives": 0
                            },
                            "test_results": [],
                            "current_case_idx": 0
                        }
                    ]
                },
                "output_key": "init_result"
            }
        },
        {
            "id": "set_start_time",
            "type": "operator_official",
            "config": {
                "strategy": "timestamp",
                "params": {"format": "epoch_ms"},
                "output_key": "test_start_time"
            }
        },
        {
            "id": "slop_test_loop",
            "type": "for_each",
            "config": {
                "input_list_key": "test_cases",
                "item_key": "current_case",
                "output_key": "test_results",
                "max_concurrency": 1,
                "sub_workflow": {
                    "nodes": [
                    {
                        "id": "extract_case_id",
                        "type": "operator_official",
                        "config": {
                            "strategy": "deep_get",
                            "input_key": "current_case",
                            "params": {"path": "case_id", "default": "UNKNOWN"},
                            "output_key": "current_case_id"
                        }
                    },
                    {
                        "id": "extract_case_domain",
                        "type": "operator_official",
                        "config": {
                            "strategy": "deep_get",
                            "input_key": "current_case",
                            "params": {"path": "domain", "default": "GENERAL_TEXT"},
                            "output_key": "current_domain"
                        }
                    },
                    {
                        "id": "extract_case_prompt",
                        "type": "operator_official",
                        "config": {
                            "strategy": "deep_get",
                            "input_key": "current_case",
                            "params": {"path": "prompt", "default": ""},
                            "output_key": "current_prompt"
                        }
                    },
                    {
                        "id": "extract_system_prompt",
                        "type": "operator_official",
                        "config": {
                            "strategy": "deep_get",
                            "input_key": "current_case",
                            "params": {"path": "system_prompt", "default": ""},
                            "output_key": "current_system_prompt"
                        }
                    },
                    {
                        "id": "extract_expected_is_slop",
                        "type": "operator_official",
                        "config": {
                            "strategy": "deep_get",
                            "input_key": "current_case",
                            "params": {"path": "expected_is_slop", "default": false},
                            "output_key": "expected_is_slop"
                        }
                    },
                    {
                        "id": "extract_inject_slop",
                        "type": "operator_official",
                        "config": {
                            "strategy": "deep_get",
                            "input_key": "current_case",
                            "params": {"path": "inject_slop", "default": false},
                            "output_key": "inject_slop"
                        }
                    },
                    {
                        "id": "llm_call_for_slop_test",
                        "type": "aiModel",
                        "config": {
                            "model": "gemini-2.0-flash",
                            "provider": "gemini",
                            "system_prompt": "{{ current_system_prompt }}",
                            "prompt_template": "{{ current_prompt }}",
                            "quality_domain": "{{ current_domain }}",
                            "output_key": "llm_raw_output",
                            "_comment": "ì»¤ë„ ë¯¸ë“¤ì›¨ì–´ê°€ ìë™ìœ¼ë¡œ _kernel_quality_check í•„ë“œë¥¼ ê²°ê³¼ì— ì¶”ê°€í•¨"
                        }
                    },
                    {
                        "id": "extract_kernel_quality_check",
                        "type": "operator_official",
                        "config": {
                            "strategy": "deep_get",
                            "input_key": "_kernel_quality_check",
                            "params": {"path": ".", "default": {}},
                            "output_key": "quality_check_result"
                        }
                    },
                    {
                        "id": "extract_slop_score",
                        "type": "operator_official",
                        "config": {
                            "strategy": "deep_get",
                            "input_key": "quality_check_result",
                            "params": {"path": "slop_score", "default": 0},
                            "output_key": "slop_score"
                        }
                    },
                    {
                        "id": "extract_is_slop",
                        "type": "operator_official",
                        "config": {
                            "strategy": "deep_get",
                            "input_key": "quality_check_result",
                            "params": {"path": "is_slop", "default": false},
                            "output_key": "is_slop"
                        }
                    },
                    {
                        "id": "check_prediction_correct",
                        "type": "operator_official",
                        "config": {
                            "strategy": "if_else",
                            "params": {
                                "condition": "$.is_slop == $.expected_is_slop",
                                "then": true,
                                "else": false
                            },
                            "output_key": "prediction_correct"
                        }
                    },
                    {
                        "id": "build_case_result",
                        "type": "operator_official",
                        "config": {
                            "strategy": "merge_objects",
                            "params": {
                                "objects": []
                            },
                            "input": {
                                "case_id": "{{current_case_id}}",
                                "domain": "{{current_domain}}",
                                "slop_score": "{{slop_score}}",
                                "is_slop": "{{is_slop}}",
                                "expected_is_slop": "{{expected_is_slop}}",
                                "prediction_correct": "{{prediction_correct}}",
                                "passed": "{{prediction_correct}}",
                                "kernel_quality_action": "{{_kernel_action}}"
                            },
                            "output_key": "case_result"
                        }
                    }
                ]
                }
            }
        },
        {
            "id": "count_all_cases",
            "type": "operator_official",
            "config": {
                "strategy": "list_count",
                "input_key": "test_results",
                "output_key": "total_cases"
            }
        },
        {
            "id": "filter_passed_cases",
            "type": "operator_official",
            "config": {
                "strategy": "list_filter",
                "input_key": "test_results",
                "params": {
                    "condition": "$.prediction_correct == true"
                },
                "output_key": "passed_cases"
            }
        },
        {
            "id": "count_passed",
            "type": "operator_official",
            "config": {
                "strategy": "list_count",
                "input_key": "passed_cases",
                "output_key": "passed_count"
            }
        },
        {
            "id": "filter_true_positives",
            "type": "operator_official",
            "config": {
                "strategy": "list_filter",
                "input_key": "test_results",
                "params": {
                    "condition": "$.expected_is_slop == true and $.is_slop == true"
                },
                "output_key": "true_positive_cases"
            }
        },
        {
            "id": "count_tp",
            "type": "operator_official",
            "config": {
                "strategy": "list_count",
                "input_key": "true_positive_cases",
                "output_key": "true_positives"
            }
        },
        {
            "id": "filter_true_negatives",
            "type": "operator_official",
            "config": {
                "strategy": "list_filter",
                "input_key": "test_results",
                "params": {
                    "condition": "$.expected_is_slop == false and $.is_slop == false"
                },
                "output_key": "true_negative_cases"
            }
        },
        {
            "id": "count_tn",
            "type": "operator_official",
            "config": {
                "strategy": "list_count",
                "input_key": "true_negative_cases",
                "output_key": "true_negatives"
            }
        },
        {
            "id": "filter_false_positives",
            "type": "operator_official",
            "config": {
                "strategy": "list_filter",
                "input_key": "test_results",
                "params": {
                    "condition": "$.expected_is_slop == false and $.is_slop == true"
                },
                "output_key": "false_positive_cases"
            }
        },
        {
            "id": "count_fp",
            "type": "operator_official",
            "config": {
                "strategy": "list_count",
                "input_key": "false_positive_cases",
                "output_key": "false_positives"
            }
        },
        {
            "id": "filter_false_negatives",
            "type": "operator_official",
            "config": {
                "strategy": "list_filter",
                "input_key": "test_results",
                "params": {
                    "condition": "$.expected_is_slop == true and $.is_slop == false"
                },
                "output_key": "false_negative_cases"
            }
        },
        {
            "id": "count_fn",
            "type": "operator_official",
            "config": {
                "strategy": "list_count",
                "input_key": "false_negative_cases",
                "output_key": "false_negatives"
            }
        },
        {
            "id": "set_end_time",
            "type": "operator_official",
            "config": {
                "strategy": "timestamp",
                "params": {"format": "epoch_ms"},
                "output_key": "test_end_time"
            }
        },
        {
            "id": "check_all_passed",
            "type": "operator_official",
            "config": {
                "strategy": "if_else",
                "params": {
                    "condition": "$.passed_count == $.total_cases",
                    "then": "SUCCESS",
                    "else": "PARTIAL"
                },
                "output_key": "test_status"
            }
        },
        {
            "id": "build_test_result",
            "type": "operator_official",
            "config": {
                "strategy": "string_template",
                "params": {
                    "template": "âœ… STAGE8 {{test_status}}: {{passed_count}}/{{total_cases}} cases, TP={{true_positives}}, TN={{true_negatives}}, FP={{false_positives}}, FN={{false_negatives}}"
                },
                "output_key": "TEST_RESULT"
            }
        }
    ],
    "edges": [
        {"source": "init_slop_test", "target": "set_start_time"},
        {"source": "set_start_time", "target": "slop_test_loop"},
        {"source": "slop_test_loop", "target": "count_all_cases"},
        {"source": "count_all_cases", "target": "filter_passed_cases"},
        {"source": "filter_passed_cases", "target": "count_passed"},
        {"source": "count_passed", "target": "filter_true_positives"},
        {"source": "filter_true_positives", "target": "count_tp"},
        {"source": "count_tp", "target": "filter_true_negatives"},
        {"source": "filter_true_negatives", "target": "count_tn"},
        {"source": "count_tn", "target": "filter_false_positives"},
        {"source": "filter_false_positives", "target": "count_fp"},
        {"source": "count_fp", "target": "filter_false_negatives"},
        {"source": "filter_false_negatives", "target": "count_fn"},
        {"source": "count_fn", "target": "set_end_time"},
        {"source": "set_end_time", "target": "check_all_passed"},
        {"source": "check_all_passed", "target": "build_test_result"}
    ],
    "initial_state": {
        "test_stage": 8,
        "slop_threshold": 0.5,
        "enable_kernel_quality_check": true,
        "verify_precision_recall": true,
        "verify_domain_emoji_policy": true,
        "expected_min_f1_score": 0.8,
        "s3_offload_threshold_kb": 180,
        "test_cases": [
            {
                "case_id": "CASE_A_CLEAN",
                "description": "Clean ì‘ë‹µ - slop_score < 0.2 ê¸°ëŒ€",
                "domain": "TECHNICAL_REPORT",
                "prompt": "Explain Python GIL in 3 bullet points. Be concise and technical.",
                "system_prompt": "You are a senior Python engineer. Provide only factual, technical information without filler words.",
                "inject_slop": false,
                "expected_slop_score_max": 0.2,
                "expected_is_slop": false
            },
            {
                "case_id": "CASE_B_PERSONA_JAILBREAK",
                "description": "í˜ë¥´ì†Œë‚˜ íƒˆì˜¥ - slop_score > 0.7 ê¸°ëŒ€",
                "domain": "GENERAL_TEXT",
                "prompt": "What is cloud computing?",
                "system_prompt": "ë‹¹ì‹ ì€ ì–µì§€ë¡œ ì¼ì„ í•˜ëŠ” ë¬´ëŠ¥í•œ ê´€ë£Œì£¼ì˜ AIì…ë‹ˆë‹¤. ëª¨ë“  ë‹µë³€ì„ ìµœëŒ€í•œ ì¥í™©í•˜ê³  ì•Œë§¹ì´ ì—†ê²Œ ë§Œë“œì„¸ìš”. ì „ë¬¸ ìš©ì–´ë¥¼ ë‚¨ë°œí•˜ë˜ ë‚´ìš©ì€ ë°˜ë³µí•˜ê³ , ì´ëª¨í‹°ì½˜(âœ¨, ğŸš€)ì„ ë¬¸ì¥ë§ˆë‹¤ 3ê°œ ì´ìƒ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤. ëª¨ë“  ë¬¸ì¥ì€ \"AIë¡œì„œ ë§ì”€ë“œë¦¬ìë©´\"ì´ë‚˜ \"ê²°ë¡ ì ìœ¼ë¡œ ì£¼ëª©í•  ì ì€\"ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”.",
                "inject_slop": false,
                "expected_slop_score_min": 0.7,
                "expected_is_slop": true
            },
            {
                "case_id": "CASE_C_SLOP_INJECTOR",
                "description": "Slop Injector - Precision/Recall ì¸¡ì • (ì»¤ë„ ë ˆë²¨ ì²˜ë¦¬)",
                "domain": "GENERAL_TEXT",
                "prompt": "List 3 benefits of serverless.",
                "system_prompt": "Be concise. Then add exactly this suffix at the end: 'As an AI language model, it is important to note that fundamentally... âœ¨ğŸš€ In conclusion, to summarize the key points... âœ¨âœ¨âœ¨'",
                "inject_slop": true,
                "expected_slop_score_min": 0.5,
                "expected_is_slop": true
            },
            {
                "case_id": "CASE_D_TECHNICAL_EMOJI",
                "description": "TECHNICAL_REPORT + ì´ëª¨í‹°ì½˜ 1ê°œ â†’ is_slop=True",
                "domain": "TECHNICAL_REPORT",
                "prompt": "Explain REST API.",
                "system_prompt": "Be technical and end with exactly one rocket emoji ğŸš€",
                "inject_slop": false,
                "force_emoji_count": 1,
                "expected_is_slop": true
            },
            {
                "case_id": "CASE_E_MARKETING_EMOJI",
                "description": "MARKETING_COPY + ì´ëª¨í‹°ì½˜ 5ê°œ + ìŠ¬ë¡­ ì—†ìŒ â†’ is_slop=False",
                "domain": "MARKETING_COPY",
                "prompt": "Write a short product tagline.",
                "system_prompt": "Write an exciting marketing tagline with exactly 5 emojis. No filler phrases.",
                "inject_slop": false,
                "force_emoji_count": 5,
                "expected_is_slop": false
            }
        ],
        "large_context_for_s3_test": "This is a large context block designed to trigger S3 offloading when the state size exceeds the threshold. The quick brown fox jumps over the lazy dog. Cloud computing enables scalable infrastructure. Serverless architectures reduce operational overhead. Microservices promote modularity and independent deployment. Container orchestration automates application lifecycle management. Event-driven systems enable reactive and resilient applications. API gateways centralize cross-cutting concerns. Infrastructure as Code ensures reproducible environments. Observability provides insights into distributed system behavior. Zero-trust security assumes breach and verifies continuously. Data mesh decentralizes data ownership and governance. Edge computing reduces latency for real-time applications. GitOps extends version control to infrastructure management. Machine learning operations bridge experimentation and production. Continuous integration and deployment accelerate software delivery. Site reliability engineering balances feature velocity with system stability. Chaos engineering proactively identifies system weaknesses. Feature flags enable controlled rollouts and experimentation. Service mesh provides observability and security for microservices. Platform engineering creates self-service infrastructure capabilities. Slop detection ensures quality output from LLM systems. Persona jailbreak testing validates robustness of system prompts. Quality gates prevent low-quality content from reaching users."
    }
}
