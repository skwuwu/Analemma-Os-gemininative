{
    "workflow_name": "LLM Stage 7 - Parallel Multi-LLM + StateBag Merge",
    "description": "동시 다중 LLM 호출에서 상태 격리 및 결과 병합 검증 (operator_official 리팩토링)",
    "version": "2.2.0",
    "test_stage": 7,
    "nodes": [
        {
            "id": "init_parallel",
            "type": "operator_official",
            "config": {
                "strategy": "merge_objects",
                "params": {
                    "objects": [
                        {
                            "branch_prompts": [
                                "Summarize the key benefits of cloud computing.",
                                "List 3 security best practices for AWS Lambda.",
                                "Explain serverless architecture in simple terms.",
                                "Compare containers vs serverless for microservices.",
                                "Describe event-driven architecture patterns."
                            ],
                            "parallel_branches": 5,
                            "branch_configs": [
                                {"branch_id": 0, "prompt": "Summarize the key benefits of cloud computing.", "status": "pending"},
                                {"branch_id": 1, "prompt": "List 3 security best practices for AWS Lambda.", "status": "pending"},
                                {"branch_id": 2, "prompt": "Explain serverless architecture in simple terms.", "status": "pending"},
                                {"branch_id": 3, "prompt": "Compare containers vs serverless for microservices.", "status": "pending"},
                                {"branch_id": 4, "prompt": "Describe event-driven architecture patterns.", "status": "pending"}
                            ],
                            "branch_results": [],
                            "hitl_events": [],
                            "branch_start_timestamps": [],
                            "merged_statebag": {}
                        }
                    ]
                },
                "output_key": "init_result"
            }
        },
        {
            "id": "set_start_time",
            "type": "operator_official",
            "config": {
                "strategy": "timestamp",
                "params": {"format": "epoch_ms"},
                "output_key": "parallel_start_time"
            }
        },
        {
            "id": "parallel_branch_executor",
            "type": "for_each",
            "config": {
                "input_list_key": "init_result.branch_configs",
                "item_key": "current_branch",
                "output_key": "branch_results",
                "max_concurrency": 3,
                "sub_workflow": {
                    "nodes": [
                    {
                        "id": "branch_init_id",
                        "type": "operator_official",
                        "config": {
                            "strategy": "deep_get",
                            "input_key": "current_branch",
                            "params": {"path": "branch_id", "default": 0},
                            "output_key": "current_branch_id"
                        }
                    },
                    {
                        "id": "branch_init_prompt",
                        "type": "operator_official",
                        "config": {
                            "strategy": "deep_get",
                            "input_key": "current_branch",
                            "params": {"path": "prompt", "default": "Hello"},
                            "output_key": "current_prompt"
                        }
                    },
                    {
                        "id": "branch_init_time",
                        "type": "operator_official",
                        "config": {
                            "strategy": "timestamp",
                            "params": {"format": "epoch_ms"},
                            "output_key": "branch_start_time"
                        }
                    },
                    {
                        "id": "branch_init_counters",
                        "type": "operator_official",
                        "config": {
                            "strategy": "merge_objects",
                            "params": {
                                "objects": [
                                    {"branch_loop_count": 0, "branch_llm_calls": 0}
                                ]
                            },
                            "output_key": "branch_counters_init"
                        }
                    },
                    {
                        "id": "branch_loop",
                        "type": "loop",
                        "config": {
                            "max_iterations": 2,
                            "condition": "state.get('branch_loop_count', 0) < state.get('max_loop_per_branch', 2)",
                            "nodes": [
                                {
                                    "id": "llm_branch_call",
                                    "type": "aiModel",
                                    "config": {
                                        "model": "gemini-2.0-flash",
                                        "provider": "gemini",
                                        "prompt_template": "{{ current_prompt }}\n\nProvide a concise, structured response in JSON format with:\n1. summary: A 2-3 sentence summary\n2. key_points: List of 3-5 key points\n3. confidence: Your confidence score (0-1)",
                                        "response_schema": {
                                            "type": "object",
                                            "properties": {
                                                "summary": {"type": "string"},
                                                "key_points": {"type": "array", "items": {"type": "string"}},
                                                "confidence": {"type": "number"}
                                            },
                                            "required": ["summary", "key_points", "confidence"]
                                        },
                                        "output_key": "llm_branch_raw"
                                    }
                                },
                                {
                                    "id": "parse_llm_result",
                                    "type": "operator_official",
                                    "config": {
                                        "strategy": "json_parse",
                                        "input_key": "llm_branch_raw",
                                        "params": {"strict": false, "default": {"confidence": 0.7, "summary": "Parse failed", "key_points": []}},
                                        "output_key": "llm_parsed"
                                    }
                                },
                                {
                                    "id": "extract_confidence",
                                    "type": "operator_official",
                                    "config": {
                                        "strategy": "deep_get",
                                        "input_key": "llm_parsed",
                                        "params": {"path": "confidence", "default": 0.7},
                                        "output_key": "branch_confidence"
                                    }
                                },
                                {
                                    "id": "extract_summary",
                                    "type": "operator_official",
                                    "config": {
                                        "strategy": "deep_get",
                                        "input_key": "llm_parsed",
                                        "params": {"path": "summary", "default": ""},
                                        "output_key": "branch_summary"
                                    }
                                },
                                {
                                    "id": "extract_key_points",
                                    "type": "operator_official",
                                    "config": {
                                        "strategy": "deep_get",
                                        "input_key": "llm_parsed",
                                        "params": {"path": "key_points", "default": []},
                                        "output_key": "branch_key_points"
                                    }
                                },
                                {
                                    "id": "increment_loop_count",
                                    "type": "operator_official",
                                    "config": {
                                        "strategy": "math_expression",
                                        "input_key": "branch_loop_count",
                                        "params": {"expression": "x + 1", "default": 1},
                                        "output_key": "branch_loop_count"
                                    }
                                },
                                {
                                    "id": "increment_llm_calls",
                                    "type": "operator_official",
                                    "config": {
                                        "strategy": "math_expression",
                                        "input_key": "branch_llm_calls",
                                        "params": {"expression": "x + 1", "default": 1},
                                        "output_key": "branch_llm_calls"
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "id": "check_branch_hitl",
                        "type": "operator_official",
                        "config": {
                            "strategy": "if_else",
                            "params": {
                                "condition": "$.current_branch_id == $.hitl_at_branch and $.hitl_enabled == true",
                                "then": true,
                                "else": false
                            },
                            "output_key": "branch_hitl_required"
                        }
                    },
                    {
                        "id": "branch_hitl",
                        "type": "hitl",
                        "config": {
                            "condition": "state.get('branch_hitl_required', False)",
                            "question": "브랜치 분석 결과를 승인하시겠습니까?",
                            "context_keys": ["current_branch_id", "branch_summary", "branch_confidence"],
                            "auto_approve": true,
                            "auto_approve_delay_ms": 100
                        }
                    },
                    {
                        "id": "record_hitl_event",
                        "type": "operator_official",
                        "config": {
                            "strategy": "if_else",
                            "params": {
                                "condition": "$.branch_hitl_required == true",
                                "then": {"branch_id": "{{current_branch_id}}", "decision": "approved"},
                                "else": null
                            },
                            "output_key": "hitl_event_record"
                        }
                    },
                    {
                        "id": "finalize_branch_time",
                        "type": "operator_official",
                        "config": {
                            "strategy": "timestamp",
                            "params": {"format": "epoch_ms"},
                            "output_key": "branch_end_time"
                        }
                    },
                    {
                        "id": "build_branch_result",
                        "type": "operator_official",
                        "config": {
                            "strategy": "merge_objects",
                            "params": {
                                "objects": []
                            },
                            "input": {
                                "branch_id": "{{current_branch_id}}",
                                "status": "completed",
                                "prompt": "{{current_prompt}}",
                                "summary": "{{branch_summary}}",
                                "key_points": "{{branch_key_points}}",
                                "confidence": "{{branch_confidence}}",
                                "loop_iterations": "{{branch_loop_count}}",
                                "llm_calls": "{{branch_llm_calls}}",
                                "usage": "{{usage}}"
                            },
                            "output_key": "branch_final_result"
                        }
                    }
                ]
                }
            }
        },
        {
            "id": "count_completed_branches",
            "type": "operator_official",
            "config": {
                "strategy": "list_filter",
                "input_key": "branch_results",
                "params": {
                    "condition": "$.branch_final_result.status == 'completed'"
                },
                "output_key": "completed_branches"
            }
        },
        {
            "id": "extract_all_summaries",
            "type": "operator_official",
            "config": {
                "strategy": "list_map",
                "input_key": "branch_results",
                "params": {"field": "branch_final_result.summary"},
                "output_key": "all_summaries"
            }
        },
        {
            "id": "extract_all_key_points",
            "type": "operator_official",
            "config": {
                "strategy": "list_reduce",
                "input_key": "branch_results",
                "params": {
                    "operation": "concat",
                    "field": "branch_final_result.key_points"
                },
                "output_key": "all_key_points_nested"
            }
        },
        {
            "id": "count_total_llm_calls",
            "type": "operator_official",
            "config": {
                "strategy": "list_reduce",
                "input_key": "branch_results",
                "params": {
                    "operation": "sum",
                    "field": "branch_final_result.llm_calls"
                },
                "output_key": "total_llm_calls"
            }
        },
        {
            "id": "find_max_confidence",
            "type": "operator_official",
            "config": {
                "strategy": "list_reduce",
                "input_key": "branch_results",
                "params": {
                    "operation": "max",
                    "field": "branch_final_result.confidence"
                },
                "output_key": "max_confidence"
            }
        },
        {
            "id": "build_merged_statebag",
            "type": "operator_official",
            "config": {
                "strategy": "merge_objects",
                "params": {
                    "objects": []
                },
                "input": {
                    "all_summaries": "{{all_summaries}}",
                    "total_llm_calls": "{{total_llm_calls}}",
                    "max_confidence": "{{max_confidence}}"
                },
                "output_key": "merged_statebag"
            }
        },
        {
            "id": "set_end_time",
            "type": "operator_official",
            "config": {
                "strategy": "timestamp",
                "params": {"format": "epoch_ms"},
                "output_key": "parallel_end_time"
            }
        },
        {
            "id": "count_completed",
            "type": "operator_official",
            "config": {
                "strategy": "list_count",
                "input_key": "completed_branches",
                "output_key": "completed_count"
            }
        },
        {
            "id": "count_hitl_events",
            "type": "operator_official",
            "config": {
                "strategy": "list_count",
                "input_key": "hitl_events",
                "params": {"default": 0},
                "output_key": "hitl_count"
            }
        },
        {
            "id": "check_success",
            "type": "operator_official",
            "config": {
                "strategy": "if_else",
                "params": {
                    "condition": "$.completed_count >= $.parallel_branches",
                    "then": "SUCCESS",
                    "else": "PARTIAL"
                },
                "output_key": "test_status"
            }
        },
        {
            "id": "build_test_result",
            "type": "operator_official",
            "config": {
                "strategy": "string_template",
                "params": {
                    "template": "✅ STAGE7 {{test_status}}: {{completed_count}}/{{parallel_branches}} branches, {{hitl_count}} HITLs, {{total_llm_calls}} LLM calls, max_confidence={{max_confidence}}"
                },
                "output_key": "TEST_RESULT"
            }
        }
    ],
    "edges": [
        {"source": "init_parallel", "target": "set_start_time"},
        {"source": "set_start_time", "target": "parallel_branch_executor"},
        {"source": "parallel_branch_executor", "target": "count_completed_branches"},
        {"source": "count_completed_branches", "target": "extract_all_summaries"},
        {"source": "extract_all_summaries", "target": "extract_all_key_points"},
        {"source": "extract_all_key_points", "target": "count_total_llm_calls"},
        {"source": "count_total_llm_calls", "target": "find_max_confidence"},
        {"source": "find_max_confidence", "target": "build_merged_statebag"},
        {"source": "build_merged_statebag", "target": "set_end_time"},
        {"source": "set_end_time", "target": "count_completed"},
        {"source": "count_completed", "target": "count_hitl_events"},
        {"source": "count_hitl_events", "target": "check_success"},
        {"source": "check_success", "target": "build_test_result"}
    ],
    "initial_state": {
        "test_stage": 7,
        "parallel_branches": 5,
        "max_concurrency": 3,
        "max_loop_per_branch": 2,
        "hitl_enabled": true,
        "hitl_at_branch": 2,
        "hitl_events": [],
        "verify_statebag_merge_integrity": true,
        "expected_zero_loss": true,
        "verify_cost_aggregation": true,
        "dummy_content_size_kb": 20,
        "s3_offload_threshold_kb": 180,
        "verify_s3_offload": true
    }
}
