{
    "workflow_name": "LLM Stage 6 - Distributed MAP_REDUCE + Loop + HITL",
    "description": "분산 MAP_REDUCE 모드에서 LLM 호출, Loop 반복, HITL 승인 통합 검증 (operator_official 리팩토링)",
    "version": "2.2.0",
    "test_stage": 6,
    "nodes": [
        {
            "id": "init_distributed",
            "type": "operator_official",
            "config": {
                "strategy": "merge_objects",
                "params": {
                    "objects": [
                        {
                            "distributed_mode": true,
                            "distributed_strategy": "MAP_REDUCE",
                            "partition_results": [],
                            "loop_iterations": [],
                            "hitl_events": [],
                            "providers_used": []
                        }
                    ]
                },
                "output_key": "init_result"
            }
        },
        {
            "id": "set_start_time",
            "type": "operator_official",
            "config": {
                "strategy": "timestamp",
                "params": {"format": "epoch_ms"},
                "output_key": "test_start_time"
            }
        },
        {
            "id": "distributed_map_processor",
            "type": "for_each",
            "config": {
                "input_list_key": "partition_map",
                "item_key": "current_partition",
                "output_key": "partition_results",
                "max_concurrency": 3,
                "sub_workflow": {
                    "nodes": [
                    {
                        "id": "partition_init_id",
                        "type": "operator_official",
                        "config": {
                            "strategy": "deep_get",
                            "input_key": "current_partition",
                            "params": {"path": "partition_id", "default": 0},
                            "output_key": "current_partition_id"
                        }
                    },
                    {
                        "id": "partition_init_items",
                        "type": "operator_official",
                        "config": {
                            "strategy": "deep_get",
                            "input_key": "current_partition",
                            "params": {"path": "items", "default": []},
                            "output_key": "current_partition_items"
                        }
                    },
                    {
                        "id": "partition_init_time",
                        "type": "operator_official",
                        "config": {
                            "strategy": "timestamp",
                            "params": {"format": "epoch_ms"},
                            "output_key": "partition_start_time"
                        }
                    },
                    {
                        "id": "partition_init_counters",
                        "type": "operator_official",
                        "config": {
                            "strategy": "merge_objects",
                            "params": {
                                "objects": [
                                    {"partition_loop_count": 0, "partition_llm_results": [], "loop_convergence_score": 0}
                                ]
                            },
                            "output_key": "partition_counters_init"
                        }
                    },
                    {
                        "id": "partition_loop",
                        "type": "loop",
                        "config": {
                            "max_iterations": 2,
                            "condition": "state.get('loop_convergence_score', 0) < state.get('loop_convergence_threshold', 0.8)",
                            "nodes": [
                                {
                                    "id": "llm_analyze_partition",
                                    "type": "aiModel",
                                    "config": {
                                        "model": "gemini-2.0-flash",
                                        "provider": "gemini",
                                        "prompt_template": "Analyze the following documents and extract key insights:\n\n{% for item in state.current_partition_items %}\n- {{ item.content }}\n{% endfor %}\n\nProvide a structured JSON response with:\n1. main_themes: List of main themes\n2. sentiment: Overall sentiment (positive/neutral/negative)\n3. key_entities: Important entities mentioned\n4. confidence_score: Your confidence in this analysis (0-1)",
                                        "response_schema": {
                                            "type": "object",
                                            "properties": {
                                                "main_themes": {"type": "array", "items": {"type": "string"}},
                                                "sentiment": {"type": "string", "enum": ["positive", "neutral", "negative"]},
                                                "key_entities": {"type": "array", "items": {"type": "string"}},
                                                "confidence_score": {"type": "number"}
                                            },
                                            "required": ["main_themes", "sentiment", "confidence_score"]
                                        },
                                        "output_key": "llm_analysis_raw"
                                    }
                                },
                                {
                                    "id": "parse_llm_result",
                                    "type": "operator_official",
                                    "config": {
                                        "strategy": "json_parse",
                                        "input_key": "llm_analysis_raw",
                                        "params": {"strict": false, "default": {"confidence_score": 0.5, "main_themes": [], "sentiment": "neutral"}},
                                        "output_key": "llm_parsed"
                                    }
                                },
                                {
                                    "id": "extract_confidence",
                                    "type": "operator_official",
                                    "config": {
                                        "strategy": "deep_get",
                                        "input_key": "llm_parsed",
                                        "params": {"path": "confidence_score", "default": 0.5},
                                        "output_key": "loop_convergence_score"
                                    }
                                },
                                {
                                    "id": "increment_loop_count",
                                    "type": "operator_official",
                                    "config": {
                                        "strategy": "math_expression",
                                        "input_key": "partition_loop_count",
                                        "params": {"expression": "x + 1", "default": 1},
                                        "output_key": "partition_loop_count"
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "id": "check_hitl_trigger",
                        "type": "operator_official",
                        "config": {
                            "strategy": "if_else",
                            "params": {
                                "condition": "$.current_partition_id == $.hitl_checkpoint_at_partition and $.hitl_enabled == true",
                                "then": true,
                                "else": false
                            },
                            "output_key": "hitl_required"
                        }
                    },
                    {
                        "id": "hitl_approval",
                        "type": "hitl",
                        "config": {
                            "condition": "state.get('hitl_required', False)",
                            "question": "파티션 분석 결과를 승인하시겠습니까?",
                            "context_keys": ["current_partition_id", "loop_convergence_score"],
                            "auto_approve": true,
                            "auto_approve_delay_ms": 100
                        }
                    },
                    {
                        "id": "finalize_partition_time",
                        "type": "operator_official",
                        "config": {
                            "strategy": "timestamp",
                            "params": {"format": "epoch_ms"},
                            "output_key": "partition_end_time"
                        }
                    },
                    {
                        "id": "build_partition_result",
                        "type": "operator_official",
                        "config": {
                            "strategy": "merge_objects",
                            "params": {
                                "objects": []
                            },
                            "input": {
                                "partition_id": "{{current_partition_id}}",
                                "status": "completed",
                                "loop_iterations": "{{partition_loop_count}}",
                                "final_confidence": "{{loop_convergence_score}}",
                                "usage": "{{usage}}"
                            },
                            "output_key": "partition_final_result"
                        }
                    }
                ]
                }
            }
        },
        {
            "id": "count_completed_partitions",
            "type": "operator_official",
            "config": {
                "strategy": "list_filter",
                "input_key": "partition_results",
                "params": {
                    "condition": "$.status == 'completed'"
                },
                "output_key": "completed_partitions"
            }
        },
        {
            "id": "count_total_iterations",
            "type": "operator_official",
            "config": {
                "strategy": "list_reduce",
                "input_key": "partition_results",
                "params": {
                    "operation": "sum",
                    "field": "loop_iterations"
                },
                "output_key": "total_loop_iterations"
            }
        },
        {
            "id": "calc_avg_confidence",
            "type": "operator_official",
            "config": {
                "strategy": "list_reduce",
                "input_key": "partition_results",
                "params": {
                    "operation": "avg",
                    "field": "final_confidence"
                },
                "output_key": "average_confidence"
            }
        },
        {
            "id": "set_end_time",
            "type": "operator_official",
            "config": {
                "strategy": "timestamp",
                "params": {"format": "epoch_ms"},
                "output_key": "test_end_time"
            }
        },
        {
            "id": "count_completed",
            "type": "operator_official",
            "config": {
                "strategy": "list_count",
                "input_key": "completed_partitions",
                "output_key": "completed_count"
            }
        },
        {
            "id": "count_hitl_events",
            "type": "operator_official",
            "config": {
                "strategy": "list_count",
                "input_key": "hitl_events",
                "params": {"default": 0},
                "output_key": "hitl_count"
            }
        },
        {
            "id": "check_success",
            "type": "operator_official",
            "config": {
                "strategy": "if_else",
                "params": {
                    "condition": "$.completed_count >= $.partition_count",
                    "then": "SUCCESS",
                    "else": "PARTIAL"
                },
                "output_key": "test_status"
            }
        },
        {
            "id": "build_test_result",
            "type": "operator_official",
            "config": {
                "strategy": "string_template",
                "params": {
                    "template": "✅ STAGE6 {{test_status}}: {{completed_count}}/{{partition_count}} partitions, {{total_loop_iterations}} iterations, {{hitl_count}} HITLs, avg_confidence={{average_confidence}}"
                },
                "output_key": "TEST_RESULT"
            }
        }
    ],
    "edges": [
        {"source": "init_distributed", "target": "set_start_time"},
        {"source": "set_start_time", "target": "distributed_map_processor"},
        {"source": "distributed_map_processor", "target": "count_completed_partitions"},
        {"source": "count_completed_partitions", "target": "count_total_iterations"},
        {"source": "count_total_iterations", "target": "calc_avg_confidence"},
        {"source": "calc_avg_confidence", "target": "set_end_time"},
        {"source": "set_end_time", "target": "count_completed"},
        {"source": "count_completed", "target": "count_hitl_events"},
        {"source": "count_hitl_events", "target": "check_success"},
        {"source": "check_success", "target": "build_test_result"}
    ],
    "initial_state": {
        "test_stage": 6,
        "distributed_mode": true,
        "distributed_strategy": "MAP_REDUCE",
        "partition_count": 3,
        "items_per_partition": 4,
        "max_concurrency": 3,
        "loop_convergence_threshold": 0.8,
        "hitl_enabled": true,
        "hitl_checkpoint_at_partition": 1,
        "hitl_events": [],
        "cost_guardrail_enabled": true,
        "max_tokens_total": 50000,
        "s3_offload_threshold_kb": 180,
        "verify_s3_offload": true,
        "partition_map": [
            {
                "partition_id": 0,
                "items": [
                    {"item_id": "item_0", "content": "Document 0: Analysis of cloud computing paradigms and their impact on modern enterprise architecture. The evolution of distributed systems has fundamentally changed how organizations approach scalability and reliability."},
                    {"item_id": "item_1", "content": "Document 1: Serverless computing represents a significant shift in application deployment strategies, enabling developers to focus on business logic rather than infrastructure management."},
                    {"item_id": "item_2", "content": "Document 2: Container orchestration platforms like Kubernetes have become essential for managing microservices at scale, providing automated deployment, scaling, and operations."},
                    {"item_id": "item_3", "content": "Document 3: Event-driven architectures enable loose coupling between services, improving system resilience and allowing for independent scaling of components."}
                ]
            },
            {
                "partition_id": 1,
                "items": [
                    {"item_id": "item_4", "content": "Document 4: Machine learning operations (MLOps) bridges the gap between data science experimentation and production deployment, ensuring reproducibility and monitoring."},
                    {"item_id": "item_5", "content": "Document 5: API gateway patterns provide centralized management of cross-cutting concerns like authentication, rate limiting, and request transformation."},
                    {"item_id": "item_6", "content": "Document 6: Infrastructure as Code (IaC) enables version-controlled, repeatable infrastructure provisioning, reducing configuration drift and improving auditability."},
                    {"item_id": "item_7", "content": "Document 7: Observability practices combining logs, metrics, and traces provide comprehensive visibility into distributed system behavior and performance."}
                ]
            },
            {
                "partition_id": 2,
                "items": [
                    {"item_id": "item_8", "content": "Document 8: Zero-trust security models assume no implicit trust, requiring verification for every access request regardless of network location."},
                    {"item_id": "item_9", "content": "Document 9: Data mesh architectures decentralize data ownership, treating data as a product with dedicated teams responsible for quality and accessibility."},
                    {"item_id": "item_10", "content": "Document 10: Edge computing brings computation closer to data sources, reducing latency and bandwidth requirements for IoT and real-time applications."},
                    {"item_id": "item_11", "content": "Document 11: GitOps practices extend DevOps principles to infrastructure and application delivery, using Git as the single source of truth."}
                ]
            }
        ],
        "large_context_for_s3_test": "This is a large context block designed to trigger S3 offloading when the state size exceeds the threshold. The quick brown fox jumps over the lazy dog. Cloud computing enables scalable infrastructure. Serverless architectures reduce operational overhead. Microservices promote modularity and independent deployment. Container orchestration automates application lifecycle management. Event-driven systems enable reactive and resilient applications. API gateways centralize cross-cutting concerns. Infrastructure as Code ensures reproducible environments. Observability provides insights into distributed system behavior. Zero-trust security assumes breach and verifies continuously. Data mesh decentralizes data ownership and governance. Edge computing reduces latency for real-time applications. GitOps extends version control to infrastructure management. Machine learning operations bridge experimentation and production. Continuous integration and deployment accelerate software delivery. Site reliability engineering balances feature velocity with system stability. Chaos engineering proactively identifies system weaknesses. Feature flags enable controlled rollouts and experimentation. Service mesh provides observability and security for microservices. Platform engineering creates self-service infrastructure capabilities."
    }
}
