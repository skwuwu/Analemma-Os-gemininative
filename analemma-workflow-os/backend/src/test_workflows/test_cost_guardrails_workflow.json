{
  "id": "COST_GUARDRAIL_TEST",
  "name": "Cost Guardrail Test Workflow",
  "description": "비용 가드레일 작동 검증을 위한 테스트 워크플로우. 안전한 범위 내에서 토큰 사용 시뮬레이션.",
  "version": "1.0.0",
  "nodes": [
    {
      "id": "cost_simulation_setup",
      "scenario_id": "retry_guard_test",
      "name": "Retry Guard - 재생성 쿼터 제한 테스트",
      "description": "MAX_REGENERATION_ATTEMPTS(3회) 초과 시 FORCE_BEST_EFFORT 반환 확인",
      "test_steps": [
        {
          "step": 1,
          "action": "generate_low_quality_content",
          "expected_verdict": "FAIL",
          "expected_retry": true
        },
        {
          "step": 2,
          "action": "regenerate_still_low_quality",
          "expected_verdict": "FAIL",
          "expected_threshold": 0.5,
          "note": "임계값 0.7 → 0.5 하향"
        },
        {
          "step": 3,
          "action": "regenerate_still_low_quality",
          "expected_verdict": "FAIL",
          "expected_threshold": 0.3,
          "note": "임계값 0.5 → 0.3 하향"
        },
        {
          "step": 4,
          "action": "attempt_fourth_regeneration",
          "expected_guardrail": "RETRY_QUOTA_EXCEEDED",
          "expected_action": "FORCE_BEST_EFFORT",
          "expected_user_message": "최대 재시도 횟수에 도달했습니다"
        }
      ],
      "assertions": {
        "max_attempts": 3,
        "final_action": "FORCE_BEST_EFFORT",
        "guardrail_triggered": true
      }
    },
    {
      "id": "simulate_safe_usage",
      "type": "operator",
      "label": "안전한 토큰 사용 시뮬레이션",
      "config": {
        "language": "python",
        "code": "# 안전한 범위(500 토큰) 사용 시뮬레이션\nstate['token_usage'] += 500\nstate['cost_estimated_usd'] = 0.005\n\nif state['token_usage'] > state['max_allowed_tokens']:\n    raise RuntimeError('Token usage trigger guardrail (unexpected for this test)')\n\nprint(f\"Token Usage: {state['token_usage']}/{state['max_allowed_tokens']}\")"
      }
    },
    {
      "id": "cost_test_validator",
      "type": "operator",
      "label": "비용 테스트 검증",
      "config": {
        "language": "python",
        "code": "# 테스트 결과 검증\nfinal_usage = state.get('token_usage', 0)\nsuccess = final_usage <= state['max_allowed_tokens']\n\nif success:\n    state['TEST_RESULT'] = '✅ COST GUARDRAIL TEST PASSED: Usage within limits'\n    state['status'] = 'SUCCEEDED'\nelse:\n    state['TEST_RESULT'] = '❌ COST GUARDRAIL TEST FAILED: Usage exceeded'\n    raise RuntimeError('Cost guardrail test failed')"
      }
    }
  ],
  "edges": [
    {
      "source": "cost_simulation_setup",
      "target": "simulate_safe_usage"
    },
    {
      "source": "simulate_safe_usage",
      "target": "cost_test_validator"
    }
  ],
  "start_node": "cost_simulation_setup"
}